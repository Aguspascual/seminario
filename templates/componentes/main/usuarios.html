<link rel="stylesheet" href="/static/css/componentes/main/usuarios.css">
<div class="encabezado">
    <div class="titulo">
        <h1>USUARIOS</h1>
        <a href="/usuario/agregar"><i class="fa-solid fa-plus"></i></a>
    </div>
    <div class="buscador">
        <input type="text" id="buscador" placeholder="Ingresa nombre" onkeyup="buscarUsuarios()">
        <i class="fa-solid fa-magnifying-glass"></i>
    </div>
</div>

<div class="contenedor-usuarios">
    <table id="tablaUsuarios">
        <thead>
            <tr>
                <th>Tipo</th>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody>
            {% for usuario in usuarios %}
                {% if usuario.tipoUsuario != 'Admin' %}
                    <tr data-id="{{ usuario.id }}"
                        data-nombre="{{ usuario.nombre }}"
                        data-apellido="{{ usuario.apellido }}"
                        data-usuario="{{ usuario.usuario }}"
                        data-correo="{{ usuario.correo }}"
                        data-dni="{{ usuario.dni }}"
                        data-tipoUsuario="{{ usuario.tipoUsuario }}"
                        data-fechaCreacion="{{ usuario.fechaCreacion or '' }}"
                        data-ultimaVez="{{ usuario.ultimaVez }}">
                        <td>{{ usuario.tipoUsuario }}</td>
                        <td>{{ usuario.nombre }}</td>
                        <td>{{ usuario.apellido }}</td>
                        <td class="accion">
                            <i class="fa-solid fa-eye ver" onclick="abrirModal({{ usuario.id }})"></i>
                            <a class="mensaje" href="/mensajes/{{ usuario.id }}"><i class="fa-solid fa-message mensaje"></i></a>
                            <button class="eliminar" onclick="eliminarUsuario({{ usuario.id }})"><i class="fa-solid fa-user-xmark"></i></button>
                        </td>
                    </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>

<div id="modalUsuario" class="modal">
    <div class="modal-contenido">
        <span class="cerrar">&times;</span>
        <h2>Detalles del Usuario</h2>
        <form id="formModificarUsuario" action="/usuario/modificar" method="post">
            <input type="hidden" id="modalId" name="id">
            <label for="modalNombre">Nombre:</label>
            <input type="text" id="modalNombre" name="nombre" required>
            <label for="modalApellido">Apellido:</label>
            <input type="text" id="modalApellido" name="apellido" required>
            <label for="modalUsuarioUsuario">Usuario:</label>
            <input type="text" id="modalUsuarioUsuario" name="usuario" required>
            <label for="modalCorreo">Correo:</label>
            <input type="email" id="modalCorreo" name="correo" required>
            <label for="modalDni">DNI:</label>
            <input type="text" id="modalDni" name="dni" required>
            <label for="modalTipoUsuario">Tipo de Usuario:</label>
            <select name="tipoUsuario" id="modalTipoUsuario" required>
                <option value="Profesor">Profesor</option>
                <option value="Alumno">Alumno</option>
                <option value="Preceptor">Preceptor</option>
                <option value="Tutor">Tutor</option>
                <option value="Director">Director</option>
            </select>
            <label for="modalFechaCreacion">Fecha de Creación:</label>
            <input type="text" id="modalFechaCreacion" name="fechaCreacion" readonly>
            <label for="modalUltimaVez">Última Vez:</label>
            <input type="text" id="modalUltimaVez" name="ultimaVez" readonly>
            <button type="submit">Modificar</button>
        </form>
    </div>
</div>

<script>
function buscarUsuarios() {
    let input = document.getElementById('buscador').value.toLowerCase();
    let filas = document.querySelectorAll('#tablaUsuarios tbody tr');
    filas.forEach(fila => {
        let texto = fila.textContent.toLowerCase();
        fila.style.display = texto.includes(input) ? '' : 'none';
    });
}

function abrirModal(idUsuario) {
    const modal = document.getElementById('modalUsuario');
    const modalId = document.getElementById('modalId');
    const modalNombre = document.getElementById('modalNombre');
    const modalApellido = document.getElementById('modalApellido');
    const modalUsuarioUsuario = document.getElementById('modalUsuarioUsuario');
    const modalCorreo = document.getElementById('modalCorreo');
    const modalDni = document.getElementById('modalDni');
    const modalTipoUsuario = document.getElementById('modalTipoUsuario');
    const modalFechaCreacion = document.getElementById('modalFechaCreacion');
    const modalUltimaVez = document.getElementById('modalUltimaVez');

    const fila = document.querySelector(`tr[data-id="${idUsuario}"]`);
    if (!fila) {
        console.error(`No se encontró la fila con ID: ${idUsuario}`);
        return;
    }

    console.log("Datos del usuario:", fila.dataset); // Agregar esta línea

    modalId.value = fila.dataset.id;
    modalNombre.value = fila.dataset.nombre;
    modalApellido.value = fila.dataset.apellido;
    modalUsuarioUsuario.value = fila.dataset.usuario;
    modalCorreo.value = fila.dataset.correo;
    modalDni.value = fila.dataset.dni;
    modalTipoUsuario.value = fila.dataset.tipousuario;
    modalFechaCreacion.value = fila.dataset.fechacreacion; // Cambiar a minúsculas
    modalUltimaVez.value = fila.dataset.ultimavez

    modal.style.display = 'block';

    const cerrar = document.querySelector('.cerrar');
    cerrar.onclick = () => modal.style.display = 'none';

    window.onclick = event => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    };
}

function eliminarUsuario(idUsuario) {
    if (!confirm('¿Estás seguro de que quieres eliminar este usuario?')) return;
    fetch(`/usuario/eliminar/${idUsuario}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) location.reload();
        })
        .catch(error => alert('Hubo un problema al eliminar el usuario.'));
}

document.getElementById('formModificarUsuario').addEventListener('submit', function(event) {
    event.preventDefault(); // Evitar el envío del formulario por defecto

    const formData = new FormData(this); // Obtener los datos del formulario

    fetch('/usuario/modificar', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message); 
        if (data.success) {
            location.reload(); 
        }
    })
    .catch(error => alert('Hubo un problema al modificar el usuario.'));
});
</script>
